name: Build QtMikMod on Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Install Qt
      # -------------------------------------------------
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: 5.15.2
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          setup-python: false

      # -------------------------------------------------
      # Install vcpkg
      # -------------------------------------------------
      - name: Install vcpkg
        shell: cmd
        run: |
          git clone --branch 2025.12.12 https://github.com/microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat

      # -------------------------------------------------
      # Install libmikmod
      # -------------------------------------------------
      - name: Install libmikmod (vcpkg)
        shell: cmd
        run: |
          .\vcpkg\vcpkg install libmikmod:x64-windows

      # -------------------------------------------------
      # Build Qt application
      # -------------------------------------------------
      - name: Build QtMikMod
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          qmake MikModPlayer.pro
          nmake

      # -------------------------------------------------
      # Deploy + Bundle (PORTABLE)
      # -------------------------------------------------
      - name: Deploy and Package
        shell: pwsh
        run: |
          $ROOT = "${{ github.workspace }}"
          $BUILD_EXE = "$ROOT\release\MikModPlayer.exe"
          $RELEASE_DIR = "$ROOT\release"

          if (-not (Test-Path $BUILD_EXE)) {
              throw "Eseguibile non trovato: $BUILD_EXE"
          }

          Write-Host "Eseguibile trovato: $BUILD_EXE"

          # -------------------------------------------------
          # 1) Deploy Qt (QtCore, QtGui, plugins, ecc.)
          # -------------------------------------------------
          & "${{ env.Qt5_Dir }}\bin\windeployqt.exe" `
            --force `
            --no-translations `
            "$BUILD_EXE"

          # -------------------------------------------------
          # 2) Copia DLL vcpkg (libmikmod + dipendenze)
          # -------------------------------------------------
          $VCPKG_BIN = "$ROOT\vcpkg\installed\x64-windows\bin"
          if (Test-Path $VCPKG_BIN) {
              Copy-Item "$VCPKG_BIN\*.dll" $RELEASE_DIR -Force
          }

          # -------------------------------------------------
          # 3) Copia runtime MSVC (FONDAMENTALE)
          # -------------------------------------------------
          $MSVC_REDIST = Get-ChildItem `
            "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Redist\MSVC" `
            -Directory | Sort-Object Name -Descending | Select-Object -First 1

          if ($MSVC_REDIST) {
              $CRT_PATH = Join-Path $MSVC_REDIST.FullName "x64\Microsoft.VC142.CRT"
              if (Test-Path $CRT_PATH) {
                  Copy-Item "$CRT_PATH\*.dll" $RELEASE_DIR -Force
              }
          }

          # -------------------------------------------------
          # 4) Copia risorse applicazione
          # -------------------------------------------------
          Copy-Item fonts   $RELEASE_DIR -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item bitmaps $RELEASE_DIR -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item mod     $RELEASE_DIR -Recurse -Force -ErrorAction SilentlyContinue

          # -------------------------------------------------
          # 5) Crea ZIP finale
          # -------------------------------------------------
          Compress-Archive `
            -Path "$RELEASE_DIR\*" `
            -DestinationPath "$ROOT\MikModPlayer-Windows.zip" `
            -Force

      # -------------------------------------------------
      # Upload artifact (CI)
      # -------------------------------------------------
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MikModPlayer-Windows
          path: MikModPlayer-Windows.zip

      # -------------------------------------------------
      # Upload asset su Release GitHub
      # -------------------------------------------------
      - name: Upload Release Asset
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v1
        with:
          files: MikModPlayer-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
